<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>賭錢 Mark App v2.6（只限 21 點｜自設賠率／轉莊｜兼容版）</title>
<style>
  :root { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans CJK HK", "PingFang HK", "Microsoft JhengHei", Arial, sans-serif; }
  body { margin:0; padding:12px; background:#f7f7f9; color:#111827; }
  h1 { font-size:18px; margin:0 0 10px; }
  .tabs { display:flex; gap:8px; margin-bottom:8px; }
  .tabbtn { padding:8px 12px; border:1px solid #d1d5db; background:#fff; border-radius:10px; cursor:pointer; }
  .tabbtn.active { background:#111827; color:#fff; border-color:#111827; }
  .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px; margin-bottom:10px; box-shadow:0 1px 0 rgba(0,0,0,.03); }
  .toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .spacer { flex:1; }
  .chip { padding:3px 8px; border:1px solid #d1d5db; border-radius:9999px; background:#f3f4f6; font-size:12px; }
  .muted { color:#6b7280; }
  input[type="text"], input[type="number"], select { padding:8px; border:1px solid #d1d5db; border-radius:10px; font-size:14px; }
  input[type="number"].units { width:70px; text-align:center; }
  button { padding:8px 12px; border:1px solid #111827; background:#111827; color:#fff; border-radius:10px; cursor:pointer; font-size:14px; }
  button.secondary { background:#fff; color:#111827; border-color:#d1d5db; }
  button.destructive { background:#ef4444; border-color:#ef4444; }
  button.small { padding:4px 8px; font-size:12px; }
  .seg { display:flex; border:1px solid #d1d5db; border-radius:10px; overflow:hidden; }
  .seg > button { border:0; background:#fff; color:#111827; padding:6px 8px; }
  .seg > button.active { background:#111827; color:#fff; }
  .player-row { border:1px solid #e5e7eb; border-radius:12px; padding:8px; background:#fafafa; margin-bottom:8px; }
  .player-head { display:flex; gap:8px; align-items:center; margin-bottom:6px; }
  .handset-wrap { display:flex; gap:8px; flex-wrap:wrap; }
  .handset { border:1px solid #e5e7eb; border-radius:12px; background:#fff; padding:6px; display:flex; flex-direction:column; gap:6px; min-width:260px; }
  .hand-top { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
  .hand-label { font-size:12px; padding:2px 6px; border:1px solid #d1d5db; border-radius:9999px; background:#fafafa; }
  .row { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
  table { width:100%; border-collapse:collapse; }
  th, td { padding:8px; border-bottom:1px solid #e5e7eb; font-size:14px; text-align:left; }
  .history { max-height:260px; overflow:auto; border:1px solid #e5e7eb; border-radius:10px; background:#fff; padding:8px; }
</style>
</head>
<body>
  <h1>賭錢 Mark App v2.6（只限 21 點）</h1>

  <div class="tabs">
    <button id="tabPlay" class="tabbtn active">Play</button>
    <button id="tabSetup" class="tabbtn">Setup</button>
  </div>

  <!-- Play Page -->
  <div id="pagePlay">
    <div class="card">
      <div class="toolbar">
        <div><strong>目前回合：</strong><span id="roundNum">1</span></div>
        <div><strong>莊家：</strong><span id="currentBanker" class="chip"></span>
          <span class="muted">(此莊還剩 <span id="bankerRoundLeft">3</span> 局；每 <span id="rotateEveryLabel">3</span> 局轉)</span>
        </div>
        <div class="spacer"></div>
        <div class="muted">（W=贏、D=和、L=輸、BJ=Blackjack；每手可買保險）</div>
      </div>
      <div class="toolbar" style="margin-top:6px;">
        <label>莊家明牌</label>
        <select id="dealerUp">
          <option value="other">其他</option>
          <option value="A">A (可買保險)</option>
        </select>
        <label class="muted" style="display:flex; align-items:center; gap:4px;"><input type="checkbox" id="dealerHasBJ" /> 莊家是 Blackjack</label>
      </div>
    </div>

    <div class="card">
      <div id="playerInputs"></div>
      <div class="toolbar" style="margin-top:8px;">
        <button id="recordRound">記錄本局</button>
        <button id="undoRound" class="secondary">撤銷上一局</button>
        <button id="resetAll" class="destructive">重置所有</button>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;">結餘</h3>
      <table>
        <thead><tr><th>玩家</th><th>角色</th><th>累計</th></tr></thead>
        <tbody id="scoreboard"></tbody>
      </table>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;">歷史</h3>
      <div class="history" id="history"></div>
    </div>
  </div>

  <!-- Setup Page -->
  <div id="pageSetup" style="display:none;">
    <div class="card">
      <div class="toolbar">
        <label for="stake">每注單位</label>
        <input id="stake" type="number" value="100" min="1" step="1" class="units" />

        <label style="margin-left:10px;">BJ 賠率</label>
        <input id="bjNum" type="number" value="3" min="1" step="1" class="units" />
        <span>:</span>
        <input id="bjDen" type="number" value="2" min="1" step="1" class="units" />

        <label style="margin-left:10px;">每 N 局轉莊</label>
        <input id="rotateEvery" type="number" value="3" min="1" step="1" class="units" />

        <div class="spacer"></div>
        <button id="saveSetup" class="secondary">儲存</button>
      </div>
    </div>

    <div class="card">
      <div class="toolbar" style="margin-bottom:6px;">
        <label class="muted">玩家名字（可增刪；順序即為輪莊順序）</label>
        <div class="spacer"></div>
        <input id="newPlayerName" type="text" placeholder="新增玩家名（自動美化大小寫）" />
        <button id="addPlayer" class="secondary">加人</button>
        <button id="loadDefault" class="secondary">載入預設名單</button>
      </div>
      <div id="nameList"></div>
    </div>
  </div>

<script>
(function(){
  var STORAGE_KEY = "banker_mark_app_v26";
  var DEFAULT_PLAYERS = ["Alan","PC","King","Eric","Kei","Ho","Kenneth"];
  var MAX_HANDS = 4;

  // storage with fallback
  var memStore = {};
  function readStore(){ try{ var raw=localStorage.getItem(STORAGE_KEY); return raw?JSON.parse(raw):null; }catch(e){ return memStore[STORAGE_KEY]?JSON.parse(memStore[STORAGE_KEY]):null; } }
  function writeStore(obj){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }catch(e){ memStore[STORAGE_KEY]=JSON.stringify(obj); } }
  function $(id){ return document.getElementById(id); }

  function capName(s){ if(!s) return s; if(s.toLowerCase()==="pc") return "PC"; return s.charAt(0).toUpperCase()+s.slice(1).toLowerCase(); }

  var state = {
    players: DEFAULT_PLAYERS.slice(),
    stake: 100,
    round: 1,
    bankerIndex: 0,
    bankerRoundCount: 0,
    rotateEvery: 3,                  // ← 可在 Setup 改
    balances: {},
    history: [],
    bj: { dealerUp:"other", dealerHasBJ:false, bjNum:3, bjDen:2 } // ← 自設賠率 X:Y
  };

  function load(){ var saved=readStore(); if(saved&&typeof saved==="object"){ for(var k in saved){ state[k]=saved[k]; } } for(var i=0;i<state.players.length;i++){ var p=state.players[i]; if(typeof state.balances[p]!=="number") state.balances[p]=0; } }
  function save(){ writeStore(state); }

  function bjRate(){ var n=Number(state.bj.bjNum)||3; var d=Number(state.bj.bjDen)||2; if(d<=0){ d=2; } return n/d; }
  function handLabel(i){ return ["A","B","C","D"][i]||String(i+1); }
  function segOutcome(name, vals){ var html='<div class="seg">'; for(var i=0;i<vals.length;i++){ html+='<button class="segbtn" data-name="'+name+'" data-val="'+vals[i]+'">'+vals[i]+'</button>'; } html+='</div>'; return html; }

  /* ---------- Setup page ---------- */
  function renderNameList(){
    var box=$("nameList"); if(!box) return; box.innerHTML="";
    for(var i=0;i<state.players.length;i++){
      var name=state.players[i];
      var row=document.createElement("div"); row.className="row"; row.style.marginTop="6px";
      row.innerHTML='<span class="chip">'+(i+1)+'</span>'
        +'<input type="text" value="'+name+'" data-idx="'+i+'" />'
        +'<button class="secondary small move-up" data-idx="'+i+'">上移</button>'
        +'<button class="secondary small move-down" data-idx="'+i+'">下移</button>'
        +'<button class="destructive small del" data-idx="'+i+'">刪</button>';
      box.appendChild(row);
    }
    var inputs=box.querySelectorAll("input[type='text']");
    for(var j=0;j<inputs.length;j++){
      inputs[j].addEventListener("change",(function(inp){ return function(){
        var i=parseInt(inp.getAttribute("data-idx"),10);
        var val=capName(inp.value.trim()); if(!val) return;
        var old=state.players[i]; state.players[i]=val;
        if(old!==val){ state.balances[val]=state.balances[old]||0; delete state.balances[old]; }
        save(); renderNameList(); renderPlayerInputs(); renderScoreboard();
      }; })(inputs[j]));
    }
    var ups=box.querySelectorAll(".move-up");
    for(var a=0;a<ups.length;a++){ ups[a].addEventListener("click",(function(b){return function(){ moveIdx(parseInt(b.dataset.idx,10),-1); };})(ups[a])); }
    var downs=box.querySelectorAll(".move-down");
    for(var b=0;b<downs.length;b++){ downs[b].addEventListener("click",(function(bn){return function(){ moveIdx(parseInt(bn.dataset.idx,10),1); };})(downs[b])); }
    var dels=box.querySelectorAll(".del");
    for(var c=0;c<dels.length;c++){ dels[c].addEventListener("click",(function(btn){return function(){ delIdx(parseInt(btn.dataset.idx,10)); };})(dels[c])); }
  }
  function moveIdx(i,d){ var j=i+d; if(j<0||j>=state.players.length) return; var t=state.players[i]; state.players[i]=state.players[j]; state.players[j]=t; if(state.bankerIndex===i) state.bankerIndex=j; else if(state.bankerIndex===j) state.bankerIndex=i; save(); renderNameList(); renderPlayerInputs(); renderScoreboard(); }
  function delIdx(i){ if(state.players.length<=2){ alert("至少保留 2 位玩家。"); return; } var name=state.players[i]; state.players.splice(i,1); delete state.balances[name]; if(state.bankerIndex>=state.players.length) state.bankerIndex=0; save(); renderNameList(); renderPlayerInputs(); renderScoreboard(); }

  /* ---------- Play page ---------- */
  function renderHeader(){
    $("roundNum").textContent=state.round;
    $("currentBanker").textContent=state.players[state.bankerIndex]||"(未設定)";
    $("bankerRoundLeft").textContent=(state.rotateEvery - state.bankerRoundCount);
    $("rotateEveryLabel").textContent=state.rotateEvery;

    $("stake").value=state.stake;
    $("bjNum").value=state.bj.bjNum; $("bjDen").value=state.bj.bjDen;
    $("rotateEvery").value=state.rotateEvery;

    $("dealerUp").value=state.bj.dealerUp; $("dealerHasBJ").checked=state.bj.dealerHasBJ;
  }

  function handsetHTML(playerName, handIdx, handsCount){
    var canBJ=(handsCount===1);
    var vals=canBJ?["W","D","L","BJ"]:["W","D","L"];
    var seg=segOutcome(playerName+"__"+handIdx, vals);
    var showIns = $("dealerUp").value==="A";
    var insHTML = showIns ? '<label class="muted" style="display:flex;align-items:center;gap:4px;"><input type="checkbox" class="ins" data-name="'+playerName+'" data-hand="'+handIdx+'" /> 保險</label>' : '';
    return ''
      +'<div class="handset">'
      +  '<div class="hand-top">'
      +    '<span class="hand-label">手 '+handLabel(handIdx)+'</span>'
      +     seg
      +    '<label class="muted" style="display:flex; align-items:center; gap:4px;"><input type="checkbox" class="dbl" data-name="'+playerName+'" data-hand="'+handIdx+'" /> Double</label>'
      +     insHTML
      +  '</div>'
      +  '<div class="row">'
      +    '<span class="muted">注數</span>'
      +    '<button class="small units-dec" data-name="'+playerName+'" data-hand="'+handIdx+'">-1</button>'
      +    '<input class="units units-input" data-name="'+playerName+'" data-hand="'+handIdx+'" type="number" value="1" min="1" step="1" />'
      +    '<button class="small units-inc" data-name="'+playerName+'" data-hand="'+handIdx+'">+1</button>'
      +    '<div class="seg">'
      +      '<button class="segchip units-x2" data-name="'+playerName+'" data-hand="'+handIdx+'">×2</button>'
      +    '</div>'
      +  '</div>'
      +'</div>';
  }

  function playerRowHTML(name, idx){
    var tag=(idx===state.bankerIndex)?' <span class="chip">莊家</span>':'';
    var handsCtr=(idx===state.bankerIndex)?'':
      '<div class="row"><span class="muted">手數</span>'
      +'<button class="small hands-dec" data-name="'+name+'">-</button>'
      +'<input class="units hands-count" data-name="'+name+'" type="number" value="1" min="1" max="'+MAX_HANDS+'" step="1" />'
      +'<button class="small hands-inc" data-name="'+name+'">+</button></div>';
    return ''
      +'<div class="player-row">'
      +  '<div class="player-head"><strong>'+name+'</strong>'+tag+'</div>'
      +  (idx===state.bankerIndex?'<div class="muted">本局由其他玩家結果自動計算</div>':'<div class="handset-wrap" data-name="'+name+'"></div>'+handsCtr)
      +'</div>';
  }

  function renderHandsetsFor(name){
    var wrap=document.querySelector('.handset-wrap[data-name="'+name+'"]'); if(!wrap) return;
    var countEl=document.querySelector('.hands-count[data-name="'+name+'"]');
    var n=1; var raw=countEl?countEl.value:"1"; var parsed=parseInt(raw,10); if(!isFinite(parsed)||parsed<1) parsed=1; if(parsed>MAX_HANDS) parsed=MAX_HANDS; n=parsed; if(countEl) countEl.value=String(n);
    wrap.innerHTML="";
    for(var i=0;i<n;i++){ wrap.insertAdjacentHTML("beforeend", handsetHTML(name,i,n)); }
    // default D
    var segs=wrap.querySelectorAll(".seg");
    for(var s=0;s<segs.length;s++){ var b=segs[s].querySelector('.segbtn[data-val="D"]'); if(b) b.classList.add("active"); }
    // bind outcome
    var segBtns=wrap.querySelectorAll(".segbtn");
    for(var q=0;q<segBtns.length;q++){ segBtns[q].addEventListener("click",(function(btn){ return function(){ var p=btn.parentElement; var all=p.querySelectorAll(".segbtn"); for(var t=0;t<all.length;t++){ all[t].classList.remove("active"); } btn.classList.add("active"); };})(segBtns[q])); }
    // bind units
    var incs=wrap.querySelectorAll(".units-inc");
    for(var a=0;a<incs.length;a++){ incs[a].addEventListener("click",(function(btn){ return function(){ var inp=wrap.querySelector('.units-input[data-name="'+btn.dataset.name+'"][data-hand="'+btn.dataset.hand+'"]'); var v=parseInt(inp.value||"1",10); if(!isFinite(v)) v=1; inp.value=String(v+1); };})(incs[a])); }
    var decs=wrap.querySelectorAll(".units-dec");
    for(var b=0;b<decs.length;b++){ decs[b].addEventListener("click",(function(btn){ return function(){ var inp=wrap.querySelector('.units-input[data-name="'+btn.dataset.name+'"][data-hand="'+btn.dataset.hand+'"]'); var v=parseInt(inp.value||"1",10); if(!isFinite(v)||v<=1) v=2; inp.value=String(v-1); };})(decs[b])); }
    var x2s=wrap.querySelectorAll(".units-x2");
    for(var c=0;c<x2s.length;c++){ x2s[c].addEventListener("click",(function(btn){ return function(){ var inp=wrap.querySelector('.units-input[data-name="'+btn.dataset.name+'"][data-hand="'+btn.dataset.hand+'"]'); var v=parseInt(inp.value||"1",10); if(!isFinite(v)||v<1) v=1; inp.value=String(v*2); };})(x2s[c])); }
  }

  function renderPlayerInputs(){
    var box=$("playerInputs"); box.innerHTML="";
    for(var i=0;i<state.players.length;i++){
      var name=state.players[i];
      var holder=document.createElement("div"); holder.innerHTML=playerRowHTML(name,i);
      var row=holder.firstElementChild; box.appendChild(row);
      if(i!==state.bankerIndex){ renderHandsetsFor(name); }
    }
    var hincs=box.querySelectorAll(".hands-inc");
    for(var hi=0;hi<hincs.length;hi++){ hincs[hi].addEventListener("click",(function(btn){ return function(){ var c=box.querySelector('.hands-count[data-name="'+btn.dataset.name+'"]'); var v=parseInt(c.value||"1",10); if(!isFinite(v)) v=1; if(v<MAX_HANDS) v++; c.value=String(v); renderHandsetsFor(btn.dataset.name); };})(hincs[hi])); }
    var hdecs=box.querySelectorAll(".hands-dec");
    for(var hd=0;hd<hdecs.length;hd++){ hdecs[hd].addEventListener("click",(function(btn){ return function(){ var c=box.querySelector('.hands-count[data-name="'+btn.dataset.name+'"]'); var v=parseInt(c.value||"1",10); if(!isFinite(v)) v=1; if(v>1) v--; c.value=String(v); renderHandsetsFor(btn.dataset.name); };})(hdecs[hd])); }
    var hcounts=box.querySelectorAll(".hands-count");
    for(var hc=0;hc<hcounts.length;hc++){ hcounts[hc].addEventListener("change",(function(inp){ return function(){ renderHandsetsFor(inp.dataset.name); };})(hcounts[hc])); }
  }

  function renderScoreboard(){
    var tbody=$("scoreboard"); tbody.innerHTML="";
    for(var i=0;i<state.players.length;i++){
      var name=state.players[i];
      var role=(i===state.bankerIndex)?"莊家":"";
      var val=state.balances[name]||0;
      var tr=document.createElement("tr"); tr.innerHTML='<td>'+name+'</td><td>'+role+'</td><td>'+val.toFixed(0)+'</td>';
      tbody.appendChild(tr);
    }
  }

  function renderHistory(){
    var box=$("history"); box.innerHTML="";
    if(!state.history.length){ var empty=document.createElement("div"); empty.className="muted"; empty.textContent="尚無記錄。"; box.appendChild(empty); return; }
    var hist=state.history.slice().reverse();
    for(var i=0;i<hist.length;i++){
      var h=hist[i]; var parts=[];
      for(var name in h.results){
        var obj=h.results[name]; var tags=[];
        for(var k=0;k<obj.hands.length;k++){
          var o=obj.hands[k];
          tags.push(o.r+(o.dbl?"(×2)":"") + "×"+o.u + (o.ins?"[保]":""));
        }
        parts.push(name+':[ '+tags.join(", ")+' ]');
      }
      var line=document.createElement("div"); line.textContent="#"+h.round+" 莊="+h.banker+" | "+parts.join(" ")+" | 庄淨="+(h.netBanker>=0?"+":"")+h.netBanker+" | BJ="+h.bjNum+':'+h.bjDen;
      box.appendChild(line);
    }
  }

  function bjMult(r,dbl,isSplitLike){ if(r==="BJ") return isSplitLike?1:bjRate(); if(r==="W") return dbl?2:1; if(r==="L") return dbl?-2:-1; return 0; }

  function snapshotResults(){
    var res={};
    for(var i=0;i<state.players.length;i++){
      if(i===state.bankerIndex) continue;
      var name=state.players[i];
      var handsEl=document.querySelectorAll('.handset-wrap[data-name="'+name+'"] .handset');
      var hands=[];
      for(var h=0;h<handsEl.length;h++){
        var segActive=handsEl[h].querySelector(".segbtn.active");
        var r=segActive?segActive.dataset.val:"D";
        var dblEl=handsEl[h].querySelector(".dbl");
        var unitsEl=handsEl[h].querySelector(".units-input");
        var u=parseInt(unitsEl?unitsEl.value:"1",10); if(!isFinite(u)||u<1) u=1;
        var insEl=handsEl[h].querySelector(".ins");
        hands.push({ r:r, dbl:!!(dblEl&&dblEl.checked), u:u, ins: !!(insEl&&insEl.checked) });
      }
      res[name]={ hands:hands };
    }
    return res;
  }

  function settleRound(results){
    var stake=Number(state.stake)||100;
    var banker=state.players[state.bankerIndex];
    var netBanker=0;
    var dealerBJ=state.bj.dealerHasBJ;
    var allowIns=state.bj.dealerUp==="A";
    var rate=bjRate();

    for(var i=0;i<state.players.length;i++){
      if(i===state.bankerIndex) continue;
      var name=state.players[i];
      var obj=results[name]; if(!obj) continue;
      var delta=0;
      var n=obj.hands.length;

      if(dealerBJ){
        for(var h=0;h<n;h++){
          var hand=obj.hands[h];
          if(!(n===1 && hand.r==="BJ")){ delta -= stake * hand.u; }
          if(allowIns && hand.ins){ delta += stake * hand.u; }
        }
      } else {
        if(allowIns){
          for(var h1=0;h1<n;h1++){ var ih=obj.hands[h1]; if(ih.ins){ delta -= stake*0.5*ih.u; } }
        }
        for(var h2=0;h2<n;h2++){
          var hand2=obj.hands[h2];
          delta += stake * hand2.u * (hand2.r==="BJ" ? (n>1?1:rate) : (hand2.r==="W" ? (hand2.dbl?2:1) : (hand2.r==="L" ? (hand2.dbl?-2:-1) : 0)));
        }
      }

      state.balances[name]=(state.balances[name]||0)+delta;
      netBanker -= delta;
    }

    state.balances[banker]=(state.balances[banker]||0)+netBanker;
    return netBanker;
  }

  function nextRoundRotateIfNeeded(){
    state.bankerRoundCount += 1;
    if(state.bankerRoundCount >= state.rotateEvery){
      state.bankerRoundCount = 0;
      state.bankerIndex = (state.bankerIndex + 1) % state.players.length;
    }
    state.round += 1;
  }

  function recordRound(){
    var results=snapshotResults();
    var banker=state.players[state.bankerIndex];
    var net=settleRound(results);
    state.history.push({ round:state.round, banker:banker, results:results, netBanker:net, stake:state.stake, bjNum:state.bj.bjNum, bjDen:state.bj.bjDen });
    nextRoundRotateIfNeeded();
    save(); renderAll();
  }

  function undoRound(){
    if(!state.history.length) return;
    var last=state.history.pop();
    if(state.bankerRoundCount===0){ state.bankerIndex=(state.bankerIndex-1+state.players.length)%state.players.length; state.bankerRoundCount=state.rotateEvery-1; }
    else { state.bankerRoundCount -= 1; }
    state.round -= 1;

    var stake=last.stake||state.stake;
    var rate=(last.bjNum&&last.bjDen)?(last.bjNum/last.bjDen):bjRate();

    var netBanker=0;
    for(var name in last.results){
      var obj=last.results[name]; var delta=0; var n=obj.hands.length;
      // dealerUp/BJ 沒紀錄於 v2.6 的 history；為簡化撤銷，我們按「當前設置」dealerUp / dealerHasBJ 反推
      var dealerBJNow=state.bj.dealerHasBJ;
      var allowInsNow=state.bj.dealerUp==="A";
      if(dealerBJNow){
        for(var h=0;h<n;h++){ var hand=obj.hands[h]; if(!(n===1 && hand.r==="BJ")){ delta -= stake*hand.u; } if(allowInsNow && hand.ins){ delta += stake*hand.u; } }
      }else{
        if(allowInsNow){ for(var h1=0;h1<n;h1++){ var ih=obj.hands[h1]; if(ih.ins){ delta -= stake*0.5*ih.u; } } }
        for(var h2=0;h2<n;h2++){ var hand2=obj.hands[h2]; var mult = (hand2.r==="BJ") ? (n>1?1:rate) : (hand2.r==="W" ? (hand2.dbl?2:1) : (hand2.r==="L" ? (hand2.dbl?-2:-1) : 0)); delta += stake*hand2.u*mult; }
      }
      state.balances[name] -= delta;
      netBanker += delta;
    }
    state.balances[last.banker] -= netBanker;
    save(); renderAll();
  }

  function resetAll(){
    if(!confirm("確定要重置所有記錄？此動作不可還原。")) return;
    var playersCopy=state.players.slice();
    state={ players:playersCopy, stake:state.stake, round:1, bankerIndex:0, bankerRoundCount:0, rotateEvery: state.rotateEvery, balances:{}, history:[], bj:{ dealerUp:"other", dealerHasBJ:false, bjNum: state.bj.bjNum, bjDen: state.bj.bjDen } };
    for(var i=0;i<state.players.length;i++){ state.balances[state.players[i]]=0; }
    save(); renderAll();
  }

  /* ---------- Bindings & Tabs ---------- */
  function bindGlobal(){
    $("tabPlay").addEventListener("click",function(){ $("tabPlay").classList.add("active"); $("tabSetup").classList.remove("active"); $("pagePlay").style.display=""; $("pageSetup").style.display="none"; });
    $("tabSetup").addEventListener("click",function(){ $("tabSetup").classList.add("active"); $("tabPlay").classList.remove("active"); $("pagePlay").style.display="none"; $("pageSetup").style.display=""; });

    $("recordRound").addEventListener("click",recordRound);
    $("undoRound").addEventListener("click",undoRound);
    $("resetAll").addEventListener("click",resetAll);

    $("dealerUp").addEventListener("change",function(){ state.bj.dealerUp=this.value; save(); renderPlayerInputs(); });
    $("dealerHasBJ").addEventListener("change",function(){ state.bj.dealerHasBJ=this.checked; save(); });

    $("saveSetup").addEventListener("click",function(){
      var stakeVal=Number($("stake").value); if(!isFinite(stakeVal)||stakeVal<=0){ alert("請輸入正確的每注數值"); return; }
      var n=Number($("bjNum").value), d=Number($("bjDen").value);
      if(!isFinite(n)||n<=0||!isFinite(d)||d<=0){ alert("BJ 賠率請輸入正整數（例如 3 : 2）"); return; }
      var rot=Number($("rotateEvery").value); if(!isFinite(rot)||rot<1){ alert("轉莊局數需 ≥ 1"); return; }
      state.stake=Math.round(stakeVal);
      state.bj.bjNum=Math.round(n); state.bj.bjDen=Math.round(d);
      state.rotateEvery=Math.round(rot);
      // 如果目前剩餘局數 > 新的 rotateEvery，要調整顯示
      if(state.bankerRoundCount>=state.rotateEvery){ state.bankerRoundCount = state.rotateEvery-1; }
      save(); renderHeader(); alert("已儲存設置");
    });

    $("addPlayer").addEventListener("click",function(){ var v=$("newPlayerName").value||""; v=capName(v); $("newPlayerName").value=""; if(!v) return; if(state.players.indexOf(v)!==-1){ alert("名字重複"); return; } state.players.push(v); state.balances[v]=0; save(); renderNameList(); renderPlayerInputs(); renderScoreboard(); });
    $("loadDefault").addEventListener("click",function(){
      if(!confirm("載入預設名單：Alan、PC、King、Eric、Kei、Ho、Kenneth？")) return;
      var currentBankerName=state.players[state.bankerIndex];
      state.players=DEFAULT_PLAYERS.slice();
      var newIdx=state.players.indexOf(currentBankerName); state.bankerIndex=newIdx>=0?newIdx:0;
      var newBalances={}; for(var i=0;i<state.players.length;i++){ var n=state.players[i]; newBalances[n]=state.balances[n]||0; }
      state.balances=newBalances; save(); renderNameList(); renderPlayerInputs(); renderScoreboard(); renderHeader();
    });
  }

  function renderAll(){ renderHeader(); renderPlayerInputs(); renderScoreboard(); renderHistory(); renderNameList(); }

  load(); bindGlobal(); renderAll();
})();
</script>
</body>
</html>
