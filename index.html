
<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>賭錢 Mark App v2.7.9（21 點｜每手保險注碼｜BJ=賠率:1）</title>
<style>
  :root { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans CJK HK","PingFang HK","Microsoft JhengHei",Arial,sans-serif; }
  body { margin:0; padding:12px; background:#f7f7f9; color:#111827; }
  h1 { font-size:18px; margin:0 0 10px; }
  .tabs { display:flex; gap:8px; margin-bottom:8px; }
  .tabbtn { padding:8px 12px; border:1px solid #d1d5db; background:#fff; border-radius:10px; cursor:pointer; color:#111827; font-weight:600; }
  .tabbtn.active { background:#111827; color:#fff; border-color:#111827; }
  .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px; margin-bottom:10px; box-shadow:0 1px 0 rgba(0,0,0,.03); }
  .toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .spacer { flex:1; }
  .chip { padding:3px 8px; border:1px solid #d1d5db; border-radius:9999px; background:#f3f4f6; font-size:12px; }
  .muted { color:#6b7280; }
  input[type="text"], input[type="number"] { padding:8px; border:1px solid #d1d5db; border-radius:10px; font-size:14px; }
  input.units { width:70px; text-align:center; }            /* Setup頁（Stake/BJ/Rotate） */
  .handset .units-input { width:56px; text-align:center; }  /* 主注碼輸入，較窄 */
  .handset .ins-units { width:56px; text-align:center; }    /* 保險注碼輸入，較窄 */
  button { padding:8px 12px; border:1px solid #111827; background:#111827; color:#fff; border-radius:10px; cursor:pointer; font-size:14px; }
  button.secondary { background:#fff; color:#111827; border-color:#d1d5db; }
  button.destructive { background:#ef4444; border-color:#ef4444; }
  button.small { padding:4px 8px; font-size:12px; }
  .seg { display:flex; border:1px solid #d1d5db; border-radius:10px; overflow:hidden; }
  .seg > button { border:0; background:#fff; color:#111827; padding:6px 8px; }
  .seg > button.active { background:#111827; color:#fff; }
  .player-row { border:1px solid #e5e7eb; border-radius:12px; padding:8px; background:#fafafa; margin-bottom:8px; }
  .player-head { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px; }
  .head-right { display:flex; align-items:center; gap:8px; }
  .fixed-hand-ctrl { display:flex; gap:6px; align-items:center; }
  .fixed-hand-ctrl .units { width:64px; text-align:center; }
  .handset-wrap { display:flex; gap:8px; flex-wrap:wrap; }
  .handset { border:1px solid #e5e7eb; border-radius:12px; background:#fff; padding:6px; display:flex; flex-direction:column; gap:6px; min-width:270px; }
  .hand-top { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
  .hand-label { font-size:12px; padding:2px 6px; border:1px solid #d1d5db; border-radius:9999px; background:#fafafa; }
  .row { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
  table { width:100%; border-collapse:collapse; }
  th, td { padding:8px; border-bottom:1px solid #e5e7eb; font-size:14px; text-align:left; }
  .history { max-height:260px; overflow:auto; border:1px solid #e5e7eb; border-radius:10px; background:#fff; padding:8px; }
</style>
</head>
<body>
  <h1>賭錢 Mark App v2.7.9（只限 21 點）</h1>

  <div class="tabs">
    <button id="tabPlay" class="tabbtn active">Play</button>
    <button id="tabSetup" class="tabbtn">Setup</button>
  </div>

  <!-- Play Page -->
  <div id="pagePlay">
    <div class="card">
      <div class="toolbar">
        <div><strong>目前回合：</strong><span id="roundNum">1</span></div>
        <div><strong>莊家：</strong><span id="currentBanker" class="chip"></span>
          <span class="muted">(此莊還剩 <span id="bankerRoundLeft">3</span> 局；每 <span id="rotateEveryLabel">3</span> 局轉)</span>
        </div>
        <div class="spacer"></div>
        <div class="muted">（W=贏、D=和、L=輸；勾 <b>BJ</b> = 以賠率:1 計；保險只受「明牌A / 莊家BJ」影響）</div>
      </div>
    </div>

    <div class="card">
      <div id="playerInputs"></div>
      <div class="toolbar" style="margin-top:8px;">
        <button id="recordRound">記錄本局</button>
        <button id="undoRound" class="secondary">撤銷上一局</button>
        <button id="resetAll" class="destructive">重置所有</button>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;">結餘</h3>
      <table>
        <thead><tr><th>玩家</th><th>角色</th><th>累計</th></tr></thead>
        <tbody id="scoreboard"></tbody>
      </table>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;">歷史</h3>
      <div class="history" id="history"></div>
    </div>
  </div>

  <!-- Setup Page -->
  <div id="pageSetup" style="display:none;">
    <div class="card">
      <div class="toolbar">
        <label>每注單位</label>
        <input id="stake" type="number" value="10" min="1" step="1" class="units" />

        <label style="margin-left:10px;">BJ 賠率</label>
        <input id="bjNum" type="number" value="2" min="1" step="1" class="units" />
        <span>:</span>
        <input id="bjDen" type="number" value="1" class="units" disabled />
        <span class="muted">（後面固定為 1）</span>

        <label style="margin-left:10px;">每 N 局轉莊</label>
        <input id="rotateEvery" type="number" value="3" min="1" step="1" class="units" />

        <div class="spacer"></div>
        <button id="saveSetup" class="secondary">儲存</button>
      </div>
    </div>

    <div class="card">
      <div class="toolbar" style="margin-bottom:6px;">
        <label class="muted">玩家名字（可增刪；順序即為輪莊順序）</label>
        <div class="spacer"></div>
        <input id="newPlayerName" type="text" placeholder="新增玩家名（自動美化大小寫）" />
        <button id="addPlayer" class="secondary">加人</button>
        <button id="loadDefault" class="secondary">載入預設名單</button>
      </div>
      <div id="nameList"></div>
    </div>
  </div>

<script>
(function(){
  var STORAGE_KEY = "banker_mark_app_v279";
  var DEFAULT_PLAYERS = ["Alan","PC","King","Eric","Kei","Ho","Kenneth"];
  var MAX_HANDS = 4;

  var memStore = {};
  function readStore(){ try{ var raw=localStorage.getItem(STORAGE_KEY); return raw?JSON.parse(raw):null; }catch(e){ return memStore[STORAGE_KEY]?JSON.parse(memStore[STORAGE_KEY]):null; } }
  function writeStore(obj){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }catch(e){ memStore[STORAGE_KEY]=JSON.stringify(obj); } }
  function $(id){ return document.getElementById(id); }
  function capName(s){ if(!s) return s; if(s.toLowerCase()==="pc") return "PC"; return s.charAt(0).toUpperCase()+s.slice(1).toLowerCase(); }
  function fmt1(n){ var v = Math.round(Number(n)*10)/10; if (Object.is(v,-0)) v = 0; return v.toFixed(1); }

  var state = {
    players: DEFAULT_PLAYERS.slice(),
    stake: 10,     // 預設 10
    round: 1,
    bankerIndex: 0,
    bankerRoundCount: 0,
    rotateEvery: 3,
    balances: {},
    history: [],
    bj: { dealerA:false, dealerHasBJ:false, bjNum:2, bjDen:1 } // bjDen 固定 1
  };

  function load(){ var saved=readStore(); if(saved&&typeof saved==="object"){ for(var k in saved){ state[k]=saved[k]; } } for(var i=0;i<state.players.length;i++){ var p=state.players[i]; if(typeof state.balances[p]!=="number") state.balances[p]=0; } }
  function save(){ writeStore(state); }

  function bjRate(){ var n=Number(state.bj.bjNum)||2; return n/1; } // 後面固定 1
  function handLabel(i){ return ["A","B","C","D"][i]||String(i+1); }
  function segOutcome(name){ // W / D / L
    var vals=["W","D","L"], html='<div class="seg">';
    for(var i=0;i<vals.length;i++){ html+='<button class="segbtn" data-name="'+name+'" data-val="'+vals[i]+'">'+vals[i]+'</button>'; }
    html+='</div>'; return html;
  }
  function activateOutcomeIn(handsetEl, val){
    var seg=handsetEl.querySelector(".seg"); if(!seg) return;
    var all=seg.querySelectorAll(".segbtn");
    for(var i=0;i<all.length;i++) all[i].classList.remove("active");
    var target=seg.querySelector('.segbtn[data-val="'+val+'"]'); if(target) target.classList.add("active");
  }

  /* ---------- Setup page ---------- */
  function renderNameList(){
    var box=$("nameList"); if(!box) return; box.innerHTML="";
    for(var i=0;i<state.players.length;i++){
      var name=state.players[i];
      var row=document.createElement("div"); row.className="row"; row.style.marginTop="6px";
      row.innerHTML='<span class="chip">'+(i+1)+'</span>'
        +'<input type="text" value="'+name+'" data-idx="'+i+'" />'
        +'<button class="secondary small move-up" data-idx="'+i+'">上移</button>'
        +'<button class="secondary small move-down" data-idx="'+i+'">下移</button>'
        +'<button class="destructive small del" data-idx="'+i}">刪</button>';
      box.appendChild(row);
    }
    var inputs=box.querySelectorAll("input[type='text']");
    for(var j=0;j<inputs.length;j++){
      inputs[j].addEventListener("change",(function(inp){ return function(){
        var i=parseInt(inp.getAttribute("data-idx"),10);
        var val=capName(inp.value.trim()); if(!val) return;
        var old=state.players[i]; state.players[i]=val;
        if(old!==val){ state.balances[val]=state.balances[old]||0; delete state.balances[old]; }
        save(); renderNameList(); renderPlayerInputs(); renderScoreboard();
      }; })(inputs[j]));
    }
    var ups=box.querySelectorAll(".move-up");
    for(var a=0;a<ups.length;a++){ ups[a].addEventListener("click",(function(b){return function(){ moveIdx(parseInt(b.dataset.idx,10),-1); };})(ups[a])); }
    var downs=box.querySelectorAll(".move-down");
    for(var b=0;b<downs.length;b++){ downs[b].addEventListener("click",(function(bn){return function(){ moveIdx(parseInt(bn.dataset.idx,10),1); };})(downs[b])); }
    var dels=box.querySelectorAll(".del");
    for(var c=0;c<dels.length;c++){ dels[c].addEventListener("click",(function(btn){return function(){ delIdx(parseInt(btn.dataset.idx,10)); };})(dels[c])); }
  }
  function moveIdx(i,d){ var j=i+d; if(j<0||j>=state.players.length) return; var t=state.players[i]; state.players[i]=state.players[j]; state.players[j]=t; if(state.bankerIndex===i) state.bankerIndex=j; else if(state.bankerIndex===j) state.bankerIndex=i; save(); renderNameList(); renderPlayerInputs(); renderScoreboard(); }
  function delIdx(i){ if(state.players.length<=2){ alert("至少保留 2 位玩家。"); return; } var name=state.players[i]; state.players.splice(i,1); delete state.balances[name]; if(state.bankerIndex>=state.players.length) state.bankerIndex=0; save(); renderNameList(); renderPlayerInputs(); renderScoreboard(); }

  /* ---------- Play page ---------- */
  function renderHeader(){
    $("roundNum").textContent=state.round;
    $("currentBanker").textContent=state.players[state.bankerIndex]||"(未設定)";
    $("bankerRoundLeft").textContent=(state.rotateEvery - state.bankerRoundCount);
    $("rotateEveryLabel").textContent=state.rotateEvery;

    $("stake").value=state.stake;
    $("bjNum").value=state.bj.bjNum; $("bjDen").value=1;
    $("rotateEvery").value=state.rotateEvery;
  }

  function dealerCtrlRowHTML(){
    return '<div class="row" id="dealerCtrl">'
      + '<label class="muted" style="display:flex;align-items:center;gap:4px;"><input type="checkbox" id="dealerA" /> 莊家明牌是 A（可買保險）</label>'
      + '<label class="muted" style="display:flex;align-items:center;gap:4px;"><input type="checkbox" id="dealerHasBJ" /> 莊家是 Blackjack</label>'
      + '</div>';
  }

  function handsetHTML(playerName, handIdx){
    var vals=segOutcome(playerName+"__"+handIdx);
    var bjHTML = '<label class="muted" style="display:flex;align-items:center;gap:4px;"><input type="checkbox" class="earlybj" data-name="'+playerName+'" data-hand="'+handIdx+'" /> BJ</label>';
    return ''
      +'<div class="handset">'
      +  '<div class="hand-top">'
      +    '<span class="hand-label">手 '+handLabel(handIdx)+'</span>'
      +     vals
      +    '<label class="muted" style="display:flex; align-items:center; gap:4px;"><input type="checkbox" class="dbl" data-name="'+playerName+'" data-hand="'+handIdx+'" /> Double</label>'
      +    '<label class="muted" style="display:flex;align-items:center;gap:4px;"><input type="checkbox" class="ins" data-name="'+playerName+'" data-hand="'+handIdx+'" /> 保險</label>'
      +    '<input class="ins-units" data-name="'+playerName+'" data-hand="'+handIdx+'" type="number" value="0" min="0" step="1" title="保險注碼（以每注單位為單位）" />'
      +  '</div>'
      +  '<div class="row">'
      +    '<span class="muted">注數</span>'
      +    '<button class="small units-dec" data-name="'+playerName+'" data-hand="'+handIdx+'">-1</button>'
      +    '<input class="units-input" data-name="'+playerName+'" data-hand="'+handIdx+'" type="number" value="1" min="1" step="1" />'
      +    '<button class="small units-inc" data-name="'+playerName+'" data-hand="'+handIdx+'">+1</button>'
      +    '<div class="seg"><button class="segchip units-x2" data-name="'+playerName+'" data-hand="'+handIdx+'">×2</button></div>'
      +     bjHTML
      +  '</div>'
      +'</div>';
  }

  function playerRowHTML(name, idx){
    var isBanker = (idx===state.bankerIndex);
    var tag=isBanker?' <span class="chip">莊家</span>':'';
    var handCtrl = isBanker ? '' :
      '<div class="fixed-hand-ctrl" data-name="'+name+'">'
      + '<span class="muted">手數</span>'
      + '<button class="small hands-dec" data-name="'+name+'">-</button>'
      + '<input class="units hands-count" data-name="'+name+'" type="number" value="1" min="1" max="'+MAX_HANDS+'" step="1" />'
      + '<button class="small hands-inc" data-name="'+name+'">+</button>'
      + '</div>';
    var note = isBanker ? '<div class="muted">本局由其他玩家結果自動計算</div>' : '';
    var dealerCtrl = isBanker ? dealerCtrlRowHTML() : '';
    return ''
      +'<div class="player-row">'
      +  '<div class="player-head">'
      +    '<div><strong>'+name+'</strong>'+tag+'</div>'
      +    '<div class="head-right">'+handCtrl+'</div>'
      +  '</div>'
      +  (isBanker? (dealerCtrl+note) : '<div class="handset-wrap" data-name="'+name+'"></div>')
      +'</div>';
  }

  function renderHandsetsFor(name){
    var wrap=document.querySelector('.handset-wrap[data-name="'+name+'"]'); if(!wrap) return;
    var countEl=document.querySelector('.hands-count[data-name="'+name+'"]');
    var n=1; var raw=countEl?countEl.value:"1"; var parsed=parseInt(raw,10); if(!isFinite(parsed)||parsed<1) parsed=1; if(parsed>MAX_HANDS) parsed=MAX_HANDS; n=parsed; if(countEl) countEl.value=String(n);
    wrap.innerHTML="";
    for(var i=0;i<n;i++){ wrap.insertAdjacentHTML("beforeend", handsetHTML(name,i)); }
    // 預設 D
    var btnGroups=wrap.querySelectorAll(".seg");
    for(var s=0;s<btnGroups.length;s++){ var b=btnGroups[s].querySelector('.segbtn[data-val="D"]'); if(b) b.classList.add("active"); }
    // outcome buttons
    var segBtns=wrap.querySelectorAll(".segbtn");
    for(var q=0;q<segBtns.length;q++){ segBtns[q].addEventListener("click",(function(btn){ return function(){ var p=btn.parentElement; var all=p.querySelectorAll(".segbtn"); for(var t=0;t<all.length;t++){ all[t].classList.remove("active"); } btn.classList.add("active"); };})(segBtns[q])); }
    // 主注碼控制
    var incs=wrap.querySelectorAll(".units-inc");
    for(var a=0;a<incs.length;a++){ incs[a].addEventListener("click",(function(btn){ return function(){ var inp=wrap.querySelector('.units-input[data-name="'+btn.dataset.name+'"][data-hand="'+btn.dataset.hand+'"]'); var v=parseInt(inp.value||"1",10); if(!isFinite(v)) v=1; inp.value=String(v+1); };})(incs[a])); }
    var decs=wrap.querySelectorAll(".units-dec");
    for(var b=0;b<decs.length;b++){ decs[b].addEventListener("click",(function(btn){ return function(){ var inp=wrap.querySelector('.units-input[data-name="'+btn.dataset.name+'"][data-hand="'+btn.dataset.hand+'"]'); var v=parseInt(inp.value||"1",10); if(!isFinite(v)||v<=1) v=2; inp.value=String(v-1); };})(decs[b])); }
    var x2s=wrap.querySelectorAll(".units-x2");
    for(var c=0;c<x2s.length;c++){ x2s[c].addEventListener("click",(function(btn){ return function(){ var inp=wrap.querySelector('.units-input[data-name="'+btn.dataset.name+'"][data-hand="'+btn.dataset.hand+'"]'); var v=parseInt(inp.value||"1",10); if(!isFinite(v)||v<1) v=1; inp.value=String(v*2); };})(x2s[c])); }
    // BJ 勾選 → 自動設為 W
    var bjChecks=wrap.querySelectorAll(".earlybj");
    for(var d=0;d<bjChecks.length;d++){
      bjChecks[d].addEventListener("change", function(){
        if(this.checked){ activateOutcomeIn(this.closest(".handset"), "W"); }
      });
    }
  }

  function renderPlayerInputs(){
    var box=$("playerInputs"); box.innerHTML="";
    for(var i=0;i<state.players.length;i++){
      var name=state.players[i];
      var holder=document.createElement("div"); holder.innerHTML=playerRowHTML(name,i);
      var row=holder.firstElementChild; box.appendChild(row);
      if(i!==state.bankerIndex){ renderHandsetsFor(name); }
    }
    // 綁定莊家 checkbox
    var dealerA=$("dealerA"), dealerBJ=$("dealerHasBJ");
    if(dealerA){ dealerA.checked=state.bj.dealerA; dealerA.addEventListener("change",function(){ state.bj.dealerA=this.checked; save(); }); }
    if(dealerBJ){ dealerBJ.checked=state.bj.dealerHasBJ; dealerBJ.addEventListener("change",function(){ state.bj.dealerHasBJ=this.checked; save(); }); }

    // 綁定手數
    var hincs=box.querySelectorAll(".hands-inc");
    for(var hi=0;hi<hincs.length;hi++){ hincs[hi].addEventListener("click",(function(btn){ return function(){ var c=box.querySelector('.hands-count[data-name="'+btn.dataset.name+'"]'); var v=parseInt(c.value||"1",10); if(!isFinite(v)) v=1; if(v<MAX_HANDS) v++; c.value=String(v); renderHandsetsFor(btn.dataset.name); };})(hincs[hi])); }
    var hdecs=box.querySelectorAll(".hands-dec");
    for(var hd=0;hd<hdecs.length;hd++){ hdecs[hd].addEventListener("click",(function(btn){ return function(){ var c=box.querySelector('.hands-count[data-name="'+btn.dataset.name+'"]'); var v=parseInt(c.value||"1",10); if(!isFinite(v)) v=1; if(v>1) v--; c.value=String(v); renderHandsetsFor(btn.dataset.name); };})(hdecs[hd])); }
    var hcounts=box.querySelectorAll(".hands-count");
    for(var hc=0;hc<hcounts.length;hc++){ hcounts[hc].addEventListener("change",(function(inp){ return function(){ renderHandsetsFor(inp.dataset.name); };})(hcounts[hc])); }
  }

  function renderScoreboard(){
    var tbody=$("scoreboard"); tbody.innerHTML="";
    for(var i=0;i<state.players.length;i++){
      var name=state.players[i];
      var role=(i===state.bankerIndex)?"莊家":"";
      var val=state.balances[name]||0;
      var tr=document.createElement("tr"); tr.innerHTML='<td>'+name+'</td><td>'+role+'</td><td>'+fmt1(val)+'</td>';
      tbody.appendChild(tr);
    }
  }

  function renderHistory(){
    var box=$("history"); box.innerHTML="";
    if(!state.history.length){ var empty=document.createElement("div"); empty.className="muted"; empty.textContent="尚無記錄。"; box.appendChild(empty); return; }
    var hist=state.history.slice().reverse();
    for(var i=0;i<hist.length;i++){
      var h=hist[i]; var parts=[];
      for(var name in h.results){
        var obj=h.results[name]; var tags=[];
        for(var k=0;k<obj.hands.length;k++){
          var o=obj.hands[k];
          var tag = (o.r)+(o.dbl?"(×2)":"") + "×"+o.u + (o.ins?"[保="+o.insU+"]":"") + (o.early?"[BJ]":"");
          tags.push(tag);
        }
        parts.push(name+':[ '+tags.join(", ")+' ]');
      }
      var line=document.createElement("div"); line.textContent="#"+h.round+" 莊="+h.banker+" | "+parts.join(" ")+" | 庄淨="+(h.netBanker>=0?"+":"")+fmt1(h.netBanker)+" | BJ="+h.params.bjNum+':1';
      box.appendChild(line);
    }
  }

  /* ===== 統一計算（含每手保險注碼） ===== */
  function computeDeltas(results, params){
    var stake=params.stake, bjNum=params.bjNum, dealerA=params.dealerA, dealerBJ=params.dealerBJ;
    function bjRateByNum(){ return (bjNum>0?bjNum:2); }
    function multForHand(hand){
      if (hand.early) return bjRateByNum(); // 勾 BJ → 賠率:1（不受 Double）
      if (hand.r==="W") return hand.dbl ? 2 : 1;
      if (hand.r==="L") return hand.dbl ? -2 : -1;
      return 0; // D
    }
    var deltas={}, netBanker=0;
    for(var name in results){
      var obj=results[name]; if(!obj) continue;
      var delta=0;

      // ▶ 先結算保險（只在明牌 A 有效；金額= insU × stake；莊家BJ → +1；否則 -1）
      if(dealerA){
        for(var h0=0; h0<obj.hands.length; h0++){
          var hh=obj.hands[h0];
          if(hh.ins && hh.insU>0){
            var insAmt = stake * hh.insU;
            delta += (dealerBJ ? +1 : -1) * insAmt;
          }
        }
      }

      // 主注輸贏
      for(var h=0; h<obj.hands.length; h++){
        var hand=obj.hands[h];
        delta += stake * hand.u * multForHand(hand);
      }
      deltas[name]=delta;
      netBanker -= delta;
    }
    return { deltas: deltas, netBanker: netBanker };
  }

  function recordRound(){
    var results=snapshotResults();
    var params={ stake: state.stake, bjNum: state.bj.bjNum, dealerA: state.bj.dealerA, dealerBJ: state.bj.dealerHasBJ };
    var calc=computeDeltas(results, params);

    // 套用
    for(var name in calc.deltas){ state.balances[name]=(state.balances[name]||0)+calc.deltas[name]; }
    var banker=state.players[state.bankerIndex];
    state.balances[banker]=(state.balances[banker]||0)+calc.netBanker;

    state.history.push({ round:state.round, banker:banker, results:results, netBanker:calc.netBanker, params:params });

    // 下一局 & 輪莊
    state.bankerRoundCount += 1;
    if(state.bankerRoundCount >= state.rotateEvery){ state.bankerRoundCount = 0; state.bankerIndex = (state.bankerIndex + 1) % state.players.length; }
    state.round += 1;

    save(); renderAll();
  }

  function undoRound(){
    if(!state.history.length) return;

    // 先回上局的位置
    if(state.bankerRoundCount===0){ state.bankerIndex=(state.bankerIndex-1+state.players.length)%state.players.length; state.bankerRoundCount=state.rotateEvery-1; }
    else { state.bankerRoundCount -= 1; }
    state.round -= 1;

    var last=state.history.pop();
    var calc=computeDeltas(last.results, last.params); // 用「當時參數」重算

    // 反向套用
    for(var name in calc.deltas){ state.balances[name]-=calc.deltas[name]; }
    state.balances[last.banker]-=calc.netBanker;

    save(); renderAll();
  }

  function resetAll(){
    if(!confirm("確定要重置所有記錄？此動作不可還原。")) return;
    var playersCopy=state.players.slice();
    state={ players:playersCopy, stake:state.stake, round:1, bankerIndex:0, bankerRoundCount:0, rotateEvery: state.rotateEvery, balances:{}, history:[], bj:{ dealerA:false, dealerHasBJ:false, bjNum: state.bj.bjNum, bjDen:1 } };
    for(var i=0;i<state.players.length;i++){ state.balances[state.players[i]]=0; }
    save(); renderAll();
  }

  function snapshotResults(){
    var res={};
    for(var i=0;i<state.players.length;i++){
      if(i===state.bankerIndex) continue;
      var name=state.players[i];
      var handsEl=document.querySelectorAll('.handset-wrap[data-name="'+name+'"] .handset');
      var hands=[];
      for(var h=0;h<handsEl.length;h++){
        var segActive=handsEl[h].querySelector(".segbtn.active");
        var r=segActive?segActive.dataset.val:"D";
        var dblEl=handsEl[h].querySelector(".dbl");
        var unitsEl=handsEl[h].querySelector(".units-input");
        var insUnitsEl=handsEl[h].querySelector(".ins-units");
        var u=parseInt(unitsEl?unitsEl.value:"1",10); if(!isFinite(u)||u<1) u=1;
        var insU=parseInt(insUnitsEl?insUnitsEl.value:"0",10); if(!isFinite(insU)||insU<0) insU=0;
        var insEl=handsEl[h].querySelector(".ins");
        var earlyEl=handsEl[h].querySelector(".earlybj"); // 勾=先手BJ
        hands.push({ r:r, dbl:!!(dblEl&&dblEl.checked), u:u, ins: !!(insEl&&insEl.checked), insU: insU, early: !!(earlyEl&&earlyEl.checked) });
      }
      res[name]={ hands:hands };
    }
    return res;
  }

  /* ---------- Bindings & Tabs ---------- */
  function bindGlobal(){
    $("tabPlay").addEventListener("click",function(){ $("tabPlay").classList.add("active"); $("tabSetup").classList.remove("active"); $("pagePlay").style.display=""; $("pageSetup").style.display="none"; });
    $("tabSetup").addEventListener("click",function(){ $("tabSetup").classList.add("active"); $("tabPlay").classList.remove("active"); $("pagePlay").style.display="none"; $("pageSetup").style.display=""; });

    $("recordRound").addEventListener("click",recordRound);
    $("undoRound").addEventListener("click",undoRound);
    $("resetAll").addEventListener("click",resetAll);

    $("saveSetup").addEventListener("click",function(){
      var stakeVal=Number($("stake").value); if(!isFinite(stakeVal)||stakeVal<=0){ alert("請輸入正確的每注數值"); return; }
      var n=Number($("bjNum").value); if(!isFinite(n)||n<=0){ alert("BJ 賠率（前面）請輸入正整數，例如 2 代表 2:1"); return; }
      var rot=Number($("rotateEvery").value); if(!isFinite(rot)||rot<1){ alert("轉莊局數需 ≥ 1"); return; }
      state.stake=Math.round(stakeVal);
      state.bj.bjNum=Math.round(n); state.bj.bjDen=1;
      state.rotateEvery=Math.round(rot);
      if(state.bankerRoundCount>=state.rotateEvery){ state.bankerRoundCount = state.rotateEvery-1; }
      save(); renderHeader(); renderPlayerInputs(); alert("已儲存設置");
    });

    $("addPlayer").addEventListener("click",function(){ var v=$("newPlayerName").value||""; v=capName(v); $("newPlayerName").value=""; if(!v) return; if(state.players.indexOf(v)!==-1){ alert("名字重複"); return; } state.players.push(v); state.balances[v]=0; save(); renderNameList(); renderPlayerInputs(); renderScoreboard(); });
    $("loadDefault").addEventListener("click",function(){
      if(!confirm("載入預設名單：Alan、PC、King、Eric、Kei、Ho、Kenneth？")) return;
      var currentBankerName=state.players[state.bankerIndex];
      state.players=DEFAULT_PLAYERS.slice();
      var newIdx=state.players.indexOf(currentBankerName); state.bankerIndex=newIdx>=0?newIdx:0;
      var newBalances={}; for(var i=0;i<state.players.length;i++){ var n=state.players[i]; newBalances[n]=state.balances[n]||0; }
      state.balances=newBalances; save(); renderNameList(); renderPlayerInputs(); renderScoreboard(); renderHeader();
    });
  }

  function renderAll(){ renderHeader(); renderPlayerInputs(); renderScoreboard(); renderHistory(); renderNameList(); }

  load(); bindGlobal(); renderAll();
})();
</script>
</body>
</html>